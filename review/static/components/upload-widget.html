<link rel="import" href="/static/components/lib/polymer/polymer.html">
<link rel="import" href="/static/components/lib/paper-input/paper-input.html">
<link rel="import" href="/static/components/lib/paper-button/paper-button.html">
<link rel="import" href="/static/components/lib/ajax-form/ajax-form.html">
<link rel="import" href="/static/components/lib/file-input/file-input.html">

<polymer-element name="upload-widget" attributes="files">
    <template>
        <form id="fileform" is="ajax-form" action="../../upload" method="post" enctype="multipart/form-data">
        <paper-input-decorator floatinglabel label="Upload Name">
            <input type="text" name="name"/>
        </paper-input-decorator>
            <div class="files">
                <template repeat="{{file, idx in files}}">
                    <span>
                        <paper-button class="delete" role="button" tabindex="0" data-file-idx={{idx}} on-click="{{clickDelete}}">
                              {{file.name}}
                              <core-icon icon="clear" aria-label="clear" role="img"><svg viewBox="0 0 24 24" height="100%" width="100%" preserveAspectRatio="xMidYMid meet" fit="" style="pointer-events: none; display: block;"><g><path d="M19 6.41l-1.41-1.41-5.59 5.59-5.59-5.59-1.41 1.41 5.59 5.59-5.59 5.59 1.41 1.41 5.59-5.59 5.59 5.59 1.41-1.41-5.59-5.59z"></path></g></svg></core-icon>
                        </paper-button>
                    </span>
                </template>
            </div>
        </paper-input-decorator>
        <file-input required id="addfile" name="f">Add File(s)</file-input>
        <input type="submit" />
        </form>
    </template>

    <script>
        Polymer({
            files: [],
            ready: function() {
                var poly = this;
                this.$.fileform.addEventListener('submitting', function(event){
                    // update to have all files added so far
                    event.detail.formData['f'] = poly.files;
                });
                this.$.fileform.addEventListener('submitted', function(event){
                    if (event.detail.status == 200) {
                        // TODO: this whole block needs error handling
                        var resp = JSON.parse(event.detail.response);
                        if (resp.success) {
                            var url = "view/" + resp.id;
                            window.location.href = url;
                        }
                    }
                });
                this.$.addfile.addEventListener('change',function(event) {
                    // add files to files array
                    for (i in event.detail.valid) {
                        poly.files.push(event.detail.valid[i]);
                    }

                    // clear input fields known value, so file can be reinputted if deleted. files to upload will be in poly.files
                    this.$.fileInput.value = null;
                });
            },
            clickDelete: function(event) {
                // remove item from files array
                var idx = event.currentTarget.attributes["data-file-idx"].value
                this.files.splice(idx, 1);
            }
        });
    </script>
</polymer-element>
